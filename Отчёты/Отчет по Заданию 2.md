# Отчет по Заданию 2: Проектирование Базы Данных и Управление Доступом

## 1. Проектирование ER-диаграммы и Нормализация

Проектирование базы данных выполнено с учетом требований 3-й нормальной формы (3НФ) для обеспечения целостности данных и минимизации избыточности.

### Сущности и Атрибуты

| Сущность | Атрибуты (Ключи) | Описание |
| :--- | :--- | :--- |
| **users** | `user_id` (PK), `fio`, `phone`, `login` (UNIQUE), `password`, `user_type` (Роль), `created_at` | Хранение информации о пользователях системы. |
| **requests** | `request_id` (PK), `start_date`, `climate_tech_type`, `climate_tech_model`, `problem_description`, `request_status`, `completion_date`, `repair_parts`, `master_id` (FK -> users), `client_id` (FK -> users), `created_at`, `updated_at` | Хранение информации о заявках на ремонт. |
| **comments** | `comment_id` (PK), `message`, `created_at`, `master_id` (FK -> users), `request_id` (FK -> requests) | Хранение комментариев к заявкам. |

### Обеспечение 3-й Нормальной Формы (3НФ)

*   **1НФ:** Все атрибуты атомарны (например, ФИО не разделено, но это допустимо для данного контекста).
*   **2НФ:** Отсутствуют частичные зависимости неключевых атрибутов от составного ключа (ключи во всех таблицах простые).
*   **3НФ:** Отсутствуют транзитивные зависимости. Например, `user_type` (Роль) не вынесен в отдельную таблицу, так как список ролей фиксирован и не имеет дополнительных атрибутов, что упрощает схему и соответствует требованиям предметной области.

### Ссылочная Целостность

Ссылочная целостность обеспечена с помощью внешних ключей (`FOREIGN KEY`) в таблице `requests` и `comments`, ссылающихся на `users` и `requests`.

*   `requests.client_id` -> `users.user_id` (`ON DELETE CASCADE`)
*   `requests.master_id` -> `users.user_id` (`ON DELETE SET NULL`)
*   `comments.master_id` -> `users.user_id` (`ON DELETE CASCADE`)
*   `comments.request_id` -> `requests.request_id` (`ON DELETE CASCADE`)

## 2. Создание и Заполнение Базы Данных

### Создание БД

База данных создается с использованием PostgreSQL. Схема таблиц определена в файле `table.sql`.

### Заполнение БД

Для переноса данных из предоставленных файлов (`inputDataUsers.txt`, `inputDataRequests.txt`, `inputDataComments.txt`) используется скрипт `import_data.py`. Скрипт обеспечивает:
1.  Чтение данных из текстовых файлов.
2.  Парсинг данных и их преобразование в необходимый формат.
3.  Вставку данных в соответствующие таблицы (`users`, `requests`, `comments`) с использованием методов класса `Database`.

## 3. Запросы к Базе Данных и Отчеты

В системе реализованы запросы для формирования отчетов и статистики, которые используются на вкладке "Статистика" в главном приложении.

| Назначение Запроса | Метод в `database_module.py` | Описание |
| :--- | :--- | :--- |
| **Общая статистика** | `get_statistics` | Возвращает общее количество заявок, завершенных заявок и среднее время ремонта. |
| **Статистика по типам** | `get_statistics` | Группирует заявки по `climate_tech_type` для вывода отчета о наиболее часто ремонтируемом оборудовании. |
| **Статистика по статусам** | `get_statistics` | Группирует заявки по `request_status` для отчета о текущем состоянии работ. |

## 4. Управление Доступом и Группы Пользователей

### Принцип Регистрации

Реализован принцип **регистрации с назначением роли Администратором**:
*   При регистрации пользователь автоматически получает минимальную роль **"Заказчик"**.
*   Возможность выбора роли при регистрации удалена.
*   Назначение других ролей (Специалист, Оператор, Менеджер и т.д.) осуществляется исключительно Администратором через вкладку "Пользователи" в главном приложении.

### Группы Пользователей и Уровни Доступа

| Группа (Роль) | Функциональные Обязанности | Уровень Доступа (Пример) |
| :--- | :--- | :--- |
| **Заказчик** | Создание и отслеживание своих заявок. | Доступ к вкладкам "Мои заявки", "Создать заявку". |
| **Специалист** | Взятие в работу доступных заявок, добавление комментариев, изменение статуса. | Доступ к вкладкам "Мои задачи", "Доступные заявки". |
| **Оператор** | Просмотр всех заявок, изменение статусов, просмотр статистики. | Доступ к вкладкам "Все заявки", "Статистика". |
| **Менеджер** | Просмотр всех заявок, статистики, управление пользователями (ограниченно). | Доступ к вкладкам "Все заявки", "Статистика", "Пользователи" (ограниченно). |
| **Администратор** | Полное управление системой. | Полный доступ ко всем вкладкам, включая "Пользователи" (смена ролей, удаление). |

Уровни доступа реализованы в `main_app.py` путем условного отображения вкладок (`self.tabs.addTab`) в зависимости от `self.current_user['user_type']`.

**Пример реализации уровня доступа:**
```python
if self.is_admin or self.current_user['user_type'] in ['Менеджер', 'Оператор', 'Менеджер по качеству']:
    self.create_statistics_tab()
```
